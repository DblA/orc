
orc-pixel
=========

Orc-pixel is a quick and dirty library showing how to extend Orc
by adding opcodes and opcode rules.  It implements compositing
pixel operations, or rather, it implements _one_ compositing pixel
operation, "IN".

At some point, the x86_ functions in orcpixel-sse.c that are copied
from orc/x86.c and orc/orcrules-sse.c will be converted to exported
functions in liborc.

The code generated by orcpixel-sse.c does not produce correct
results unless loop_shift is 0 or 1.  This patch will force that to
be true, along with changing the tests to check pixel opcodes:


diff --git a/orc/orcprogram-sse.c b/orc/orcprogram-sse.c
index 01ae501..29f8c10 100644
--- a/orc/orcprogram-sse.c
+++ b/orc/orcprogram-sse.c
@@ -108,6 +108,7 @@ orc_compiler_sse_init (OrcCompiler *compiler)
           orc_program_get_max_var_size (compiler->program));
       break;
   }
+compiler->loop_shift = 1;
 
   //compiler->long_jumps = TRUE;
 }
diff --git a/testsuite/Makefile.am b/testsuite/Makefile.am
index d4220db..a754193 100644
--- a/testsuite/Makefile.am
+++ b/testsuite/Makefile.am
@@ -4,5 +4,6 @@ TESTS = test1 test2 test3 test4 test5 test_local_opcode_execution test_compile t
 orcbin_PROGRAMS = test1 test2 test3 test4 test5 test_local_opcode_execution test_compile test_accsadubl test-schro
 
 AM_CFLAGS = $(ORC_CFLAGS)
-LIBS = $(ORC_LIBS) $(top_builddir)/orc-test/liborc-test-0.3.la
+LIBS = $(ORC_LIBS) $(top_builddir)/orc-test/liborc-test-0.3.la \
+	$(top_builddir)/orc-pixel/liborc-pixel-0.3.la
 
diff --git a/testsuite/test_compile.c b/testsuite/test_compile.c
index f95aeb5..a3f58e2 100644
--- a/testsuite/test_compile.c
+++ b/testsuite/test_compile.c
@@ -6,6 +6,7 @@
 
 #include <orc/orc.h>
 #include <orc-test/orctest.h>
+#include <orc-pixel/orcpixel.h>
 
 
 int error = FALSE;
@@ -22,8 +23,9 @@ main (int argc, char *argv[])
 
   orc_init();
   orc_test_init();
+  orc_pixel_init();
 
-  opcode_set = orc_opcode_set_get ("sys");
+  opcode_set = orc_opcode_set_get ("pixel");
 
   for(i=0;i<opcode_set->n_opcodes;i++){
     printf("/* %s %d,%d,%d %p */\n",
diff --git a/testsuite/test_local_opcode_execution.c b/testsuite/test_local_opcode_execution.c
index fc62a49..17230d6 100644
--- a/testsuite/test_local_opcode_execution.c
+++ b/testsuite/test_local_opcode_execution.c
@@ -5,6 +5,7 @@
 
 #include <orc/orc.h>
 #include <orc-test/orctest.h>
+#include <orc-pixel/orcpixel.h>
 
 
 int error = FALSE;
@@ -20,10 +21,11 @@ main (int argc, char *argv[])
   int i;
   OrcOpcodeSet *opcode_set;
 
+  orc_pixel_init();
   orc_test_init();
   orc_init();
 
-  opcode_set = orc_opcode_set_get ("sys");
+  opcode_set = orc_opcode_set_get ("pixel");
 
   for(i=0;i<opcode_set->n_opcodes;i++){
     printf("/* %s src %d,%d,%d */\n",
